#!/bin/bash

set -eux
set -o pipefail

ENV="$1"
PLATFORM=${2:-}
FILES=""
FILES="$FILES -f settings/all.json"
FILES="$FILES -f settings/all.specific.json"
FILES="$FILES -f settings/*$ENV.json"

if [ -f settings/*$ENV.specific.json ]; then
  FILES="$FILES -f settings/*$ENV.specific.json"
fi

if [ -f settings/*$ENV.local.json ]; then
  FILES="$FILES -f settings/*$ENV.local.json"
fi

if [ -f $HOME/.fixin/settings/*$ENV.private.json ]; then
  FILES="$FILES -f $HOME/.fixin/settings/*$ENV.private.json"
fi

if [ -f $HOME/.spirehq/settings/*$ENV.private.json ]; then
  FILES="$FILES -f $HOME/.spirehq/settings/*$ENV.private.json"
fi

# http://trentm.com/json/
json --deep-merge $FILES | sed s/__VERSION__/$(git rev-parse HEAD)/
